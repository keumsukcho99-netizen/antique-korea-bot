import React, { useRef, useState } from 'react';
import { 
  Trash2, Plus, CheckCircle2, 
  Loader2, Sparkles, Database,
  Camera, ShieldCheck, Microscope, Gift, LayoutDashboard,
  Target, FileSearch, History, Layers, AlertCircle
} from 'lucide-react';
import { AppraisalConfig } from '../types';

interface ArtifactUploaderProps {
  onAnalyze: (images: string[], config: AppraisalConfig) => void;
  isLoading: boolean;
  dailyCount: number;
  dailyLimit: number;
}

interface ImageItem {
  id: string;
  url: string;
  status: 'processing' | 'done';
}

const ArtifactUploader: React.FC<ArtifactUploaderProps> = ({ onAnalyze, isLoading, dailyCount, dailyLimit }) => {
  const [items, setItems] = useState<ImageItem[]>([]);
  const [config, setConfig] = useState<AppraisalConfig>({
    category: '회화/서예',
    selectedFocusIds: ['seal', 'history', 'academic', 'material'],
    depth: 'academic',
    referenceNotes: '',
    allowDigitalMuseum: true
  });
  
  const fileInputRef = useRef<HTMLInputElement>(null);
  const categories = ['회화/서예', '도자기', '금속공예', '고서/문서', '민속품', '목공예 및 목가구'];

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files;
    if (files) {
      const fileList = Array.from(files) as File[];
      fileList.slice(0, 5 - items.length).forEach((file) => {
        const id = Math.random().toString(36).substr(2, 9);
        setItems(prev => [...prev, { id, url: '', status: 'processing' }]);
        const reader = new FileReader();
        reader.onloadend = () => {
          setItems(prev => prev.map(item => 
            item.id === id ? { ...item, url: reader.result as string, status: 'done' } : item
          ));
        };
        reader.readAsDataURL(file);
      });
    }
    if (fileInputRef.current) fileInputRef.current.value = '';
  };

  const isReady = items.length >= 1 && items.every(item => item.status === 'done');
  const isLimitReached = dailyCount >= dailyLimit;

  const toggleFocus = (id: string) => {
    setConfig(prev => ({
      ...prev,
      selectedFocusIds: prev.selectedFocusIds.includes(id) 
        ? prev.selectedFocusIds.filter(fid => fid !== id)
        : [...prev.selectedFocusIds, id]
    }));
  };

  return (
    <div className="space-y-12 py-4 px-6 max-w-5xl mx-auto">
      {/* 1. 사진 업로드 영역 */}
      <div className="bg-black border-2 border-[#b8860b] p-8 md:p-12 rounded-[64px] shadow-[0_0_80px_rgba(184,134,11,0.2)] relative overflow-hidden group">
        <div className="absolute inset-0 traditional-lattice opacity-5 pointer-events-none" />
        
        <div className="flex flex-col md:flex-row md:items-center justify-between border-b border-[#b8860b]/20 pb-8 gap-6 relative z-10">
          <div className="space-y-1">
            <h3 className="text-3xl md:text-4xl font-serif-kr font-black text-white flex items-center gap-4">
              <Camera className="text-[#b8860b]" size={32} /> 정밀 고증실 입장
            </h3>
            <p className="text-gray-400 font-serif-kr text-sm italic">"Antique-Korea.com의 학술 데이터를 기반으로 고증합니다."</p>
          </div>
          <div className="flex items-center gap-4">
            <div className="bg-[#b8860b]/10 px-4 py-2 rounded-2xl border border-[#b8860b]/30">
               <p className="text-[#b8860b] text-[10px] font-black font-serif-kr uppercase tracking-tighter">
                 오늘의 고증: <span className="text-white">{dailyCount}</span> / <span className="text-white">{dailyLimit}</span> 회
               </p>
            </div>
          </div>
        </div>

        <div className="grid grid-cols-2 sm:grid-cols-5 gap-6 mt-10 relative z-10">
          {items.map((item) => (
            <div key={item.id} className="relative aspect-square rounded-[32px] overflow-hidden border-2 border-[#b8860b]/20 bg-black/80 group">
              {item.status === 'processing' ? (
                <div className="absolute inset-0 flex items-center justify-center">
                  <Loader2 className="animate-spin text-[#b8860b]" size={24} />
                </div>
              ) : (
                <>
                  <img src={item.url} className="w-full h-full object-cover" alt="Artifact" />
                  <button onClick={() => setItems(prev => prev.filter(i => i.id !== item.id))} className="absolute inset-0 bg-red-950/80 opacity-0 group-hover:opacity-100 flex items-center justify-center text-white transition-opacity">
                    <Trash2 size={24} />
                  </button>
                </>
              )}
            </div>
          ))}
          {items.length < 5 && (
            <label className="flex flex-col items-center justify-center aspect-square border-2 border-dashed border-[#b8860b]/40 rounded-[32px] cursor-pointer hover:bg-[#b8860b]/5 hover:border-[#b8860b] transition-all text-gray-600 hover:text-[#b8860b] animate-pulse">
              <Plus size={36} />
              <span className="text-[10px] font-black mt-3 font-serif-kr tracking-widest uppercase">사진 추가</span>
              <input ref={fileInputRef} type="file" className="hidden" accept="image/*" multiple onChange={handleFileChange} />
            </label>
          )}
        </div>
      </div>

      {/* 2. 감정 항목 상세 설정 */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div className="bg-black/40 p-8 rounded-[40px] border border-white/10 space-y-6">
          <label className="text-gray-300 font-serif-kr font-black flex items-center gap-3 text-lg">
            <Target size={20} className="text-[#b8860b]" /> 집중 고증 항목 선택
          </label>
          <div className="grid grid-cols-1 gap-3">
            {[
              { id: 'seal', label: '낙관 및 수결 분석', icon: FileSearch },
              { id: 'history', label: '역사적 가치 고증', icon: History },
              { id: 'academic', label: '학술적 검증 스캔', icon: ShieldCheck },
              { id: 'material', label: '보관 및 재질 분석', icon: Layers },
            ].map(focus => (
              <button
                key={focus.id}
                onClick={() => toggleFocus(focus.id)}
                className={`flex items-center justify-between p-4 rounded-2xl transition-all border ${config.selectedFocusIds.includes(focus.id) ? 'bg-[#b8860b]/10 border-[#b8860b] text-[#b8860b]' : 'bg-white/5 border-white/5 text-gray-500 hover:border-[#b8860b]/40'}`}
              >
                <div className="flex items-center gap-3">
                  <focus.icon size={18} />
                  <span className="text-sm font-serif-kr font-bold">{focus.label}</span>
                </div>
                {config.selectedFocusIds.includes(focus.id) && <CheckCircle2 size={16} />}
              </button>
            ))}
          </div>
        </div>

        <div className="space-y-8">
          <div className="bg-black/40 p-8 rounded-[40px] border border-white/10 space-y-4">
            <label className="text-gray-300 font-serif-kr font-black flex items-center gap-3 text-lg">
              <Database size={20} className="text-[#b8860b]" /> 카테고리
            </label>
            <div className="grid grid-cols-2 gap-2">
              {categories.map(cat => (
                <button
                  key={cat}
                  onClick={() => setConfig({...config, category: cat})}
                  className={`px-4 py-2 rounded-xl text-[10px] font-serif-kr transition-all border ${config.category === cat ? 'bg-[#b8860b] text-black border-transparent font-black shadow-lg' : 'bg-white/5 text-gray-500 border-white/5 hover:border-[#b8860b]/40'}`}
                >
                  {cat}
                </button>
              ))}
            </div>
          </div>
          
          <div className={`p-8 rounded-[40px] border transition-all flex items-center gap-4 cursor-pointer ${config.allowDigitalMuseum ? 'border-[#b8860b] bg-[#b8860b]/5 shadow-inner' : 'bg-black/40 border-white/10'}`} onClick={() => setConfig({...config, allowDigitalMuseum: !config.allowDigitalMuseum})}>
            <div className={`shrink-0 w-8 h-8 rounded-lg border-2 flex items-center justify-center transition-all ${config.allowDigitalMuseum ? 'bg-[#b8860b] border-[#b8860b]' : 'border-gray-700'}`}>
              {config.allowDigitalMuseum && <CheckCircle2 className="text-black" size={18} />}
            </div>
            <div className="space-y-1">
              <span className="block font-serif-kr font-black text-lg text-white">디지털 기증 동의</span>
              <p className="text-[10px] text-gray-400 font-serif-kr italic leading-relaxed">"아카이브 기증 시 Antique-Korea.com의 데이터와 더 정밀하게 대조됩니다."</p>
            </div>
          </div>
        </div>
      </div>

      {/* 3. 단일 감정 버튼 */}
      <div className="space-y-6 text-center">
        {isLimitReached ? (
          <div className="bg-red-950/20 border-2 border-red-900/40 p-8 rounded-[48px] text-red-200 font-serif-kr font-black flex flex-col items-center gap-4">
            <AlertCircle size={48} />
            <div className="space-y-1">
              <p className="text-2xl">일일 고증 한도 도달</p>
              <p className="text-sm opacity-60">오늘은 이미 {dailyLimit}번의 고증을 수행하셨습니다. 내일 다시 이용해 주세요.</p>
            </div>
          </div>
        ) : (
          <>
            <p className="text-[#b8860b] font-serif-kr font-black text-sm flex items-center justify-center gap-2">
              <Gift size={16} /> Antique-Korea.com은 과학적 고증 서비스를 무료로 제공합니다. (일일 {dailyLimit}회 한정)
            </p>
            <button
              onClick={() => onAnalyze(items.map(i => i.url), config)}
              disabled={!isReady || isLoading}
              className={`
                w-full max-w-2xl mx-auto p-12 rounded-[48px] border-2 transition-all flex flex-col items-center gap-6 text-center shadow-2xl group relative overflow-hidden
                ${!isReady || isLoading 
                  ? 'bg-gray-900 border-gray-800 text-gray-700 opacity-50 cursor-not-allowed' 
                  : 'bg-black border-[#b8860b] text-[#b8860b] hover:bg-[#b8860b] hover:text-black hover:scale-[1.01]'}
              `}
            >
              <Microscope size={64} className="group-hover:scale-110 transition-transform relative z-10" />
              <div className="space-y-1 relative z-10">
                <span className="block text-3xl font-serif-kr font-black tracking-tight">AI 정밀 학술 고증 시작</span>
                <span className="block text-sm font-serif-kr italic opacity-70">Antique-Korea.com 4대 핵심 체계 기반 과학적 가치 분석</span>
              </div>
            </button>
          </>
        )}
      </div>

      {/* Loading Overlay */}
      {isLoading && (
        <div className="fixed inset-0 bg-black/95 backdrop-blur-2xl z-[2000] flex flex-col items-center justify-center p-12 text-center">
          <Loader2 className="text-[#b8860b] animate-spin mb-8" size={80} />
          <h3 className="text-4xl font-serif-kr font-black text-white mb-6 tracking-tighter">Antique-Korea.com 데이터 대조 중...</h3>
          <div className="space-y-4 text-[#b8860b] font-serif-kr text-xl opacity-80">
             <p className="animate-pulse">낙관 및 서법 특징 추출 중...</p>
             <p className="animate-pulse delay-75">고문헌 아카이브 교차 검증 중...</p>
             <p className="animate-pulse delay-150">재질 노후화 및 시대적 기법 분석 중...</p>
          </div>
        </div>
      )}
    </div>
  );
};

export default ArtifactUploader;
